---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <BaseHead title="Accessibility docs" description="Generate accessibility docs for your components" />
  </head>
  <body>
    <Header />

    <main class="container blog">
      <h1 class="h1-small">Generate accessibility docs for a component</h1>

      <form id="a11y-form" class="a11y-form" novalidate>
        <div class="form-field">
          <label for="component">Component (required)</label>
          <input id="component" name="component" required aria-describedby="component-help component-error" />
          <p id="component-help" class="field-help">Try: Accordion, Card, Button, Tooltip or Modal</p>
          <!-- Body-sized red error with warning icon (exactly like Componenta11y page) -->
          <p id="component-error" class="field-error" hidden>Enter a component</p>
        </div>

        <div class="form-field">
          <label for="url">Storybook or docs URL</label>
          <input id="url" name="url" type="url" aria-describedby="url-help" />
          <p id="url-help" class="field-help">Try: https://webc.pie.design/</p>
        </div>

        <button id="generate-btn" type="submit" class="default-button">
          <span class="btn-text">Generate docs</span>
          <span id="btn-spinner" class="btn-spinner" aria-hidden="true" hidden></span>
        </button>
      </form>

      <!-- Body-sized status text -->
      <p id="status" class="status-message" role="status" aria-live="polite" aria-atomic="true"></p>

      <hr>

      <section id="result" class="a11y-result blog-content" hidden>
        <pre id="output"></pre>
        <div class="actions">
          <button id="copy" class="action-button">Copy markdown</button>
          <button id="download" class="action-button">Download .md</button>
        </div>
      </section>

      <p class="field-help" style="margin-top: var(--space-xl);">
        Made with <a href="https://platform.openai.com/">Open AI</a> and 
        <a href="https://docs.netlify.com/build/functions/overview/">Netlify</a>. This is an experiment I documented in a blog post. Generated content isn’t guaranteed to be accurate or complete. Please review and validate before use.
      </p>
    </main>

    <Footer />

    <style>
      [hidden] { display: none !important; }

      .a11y-result { margin-block-start: var(--space-l); }
      .a11y-result pre {
        background: #ffffff;
        padding: 1rem;
        border-radius: 12px;
        white-space: pre-wrap;
        overflow-x: auto;
        border: 2px dashed var(--color-blue);
      }
      .a11y-result .actions {
        display: flex;
        gap: var(--space-s);
        margin-top: var(--space-s);
      }

      .status-message {
        margin-top: var(--space-m);
        color: var(--color-blue, inherit);
        min-height: 1.5rem;
      }

      /* Body-sized red error with warning icon (identical to Componenta11y page) */
      .field-error {
        font-size: inherit;
        color: var(--color-red);
        display: inline-flex;
        align-items: center;
        gap: .4rem;
        margin-top: .25rem;
      }
      .field-error::before {
        content: "⚠︎";
        font-size: 1em;
        line-height: 1;
        display: inline-block;
      }

      /* Button spinner: white by default, red on hover (identical styles) */
      .btn-spinner {
        display: inline-block;
        margin-left: 0.5em;
        width: 1em;
        height: 1em;
        border: 0.2em solid var(--color-white);
        border-top: 0.2em solid transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        vertical-align: middle;
      }
      .default-button:hover .btn-spinner {
        border-color: var(--color-red);
        border-top-color: transparent;
      }

      @keyframes spin { 100% { transform: rotate(360deg); } }
      @media (prefers-reduced-motion: reduce) {
        .btn-spinner { animation: none; }
      }
    </style>

    <script type="module" is:inline>
      const form = document.getElementById('a11y-form');
      const btn  = document.getElementById('generate-btn');
      const btnSpinner = document.getElementById('btn-spinner');
      const statusEl = document.getElementById('status');
      const resultSection = document.getElementById('result');
      const outEl = document.getElementById('output');
      const copyBtn = document.getElementById('copy');
      const dlBtn = document.getElementById('download');
      const componentInput = document.getElementById('component');
      const componentError = document.getElementById('component-error');
      const urlInput = document.getElementById('url');

      let isLoading = false; // keep hover styles active; prevent double-submit

      function showLoading() {
        isLoading = true;
        statusEl.textContent = 'This references A LOT of material so might take up to 30 seconds.';
        btnSpinner.hidden = false;               // show spinner in button
        btn.setAttribute('aria-disabled', 'true');
        form.setAttribute('aria-busy', 'true');
      }
      function clearLoading() {
        isLoading = false;
        btnSpinner.hidden = true;                // hide spinner
        btn.removeAttribute('aria-disabled');
        form.removeAttribute('aria-busy');
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isLoading) return;

        componentError.hidden = true;

        const component = componentInput.value.trim();
        if (!component) {
          componentError.hidden = false;         // show body-sized red error with icon + exact text
          return;
        }
        const url = urlInput.value.trim();

        showLoading();
        resultSection.hidden = true;
        outEl.textContent = '';

        const payload = { component, url };

        try {
          const res = await fetch('/.netlify/functions/a11y-docs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const text = await res.text();
          let data; try { data = JSON.parse(text); } catch { data = { error: text }; }

          if (!res.ok) {
            const errStr = typeof data.error === 'string'
              ? data.error
              : (data.error?.error?.message || JSON.stringify(data.error));
            if (typeof errStr === 'string' && /Component field is required|Enter a component/i.test(errStr)) {
              componentError.hidden = false;
            } else {
              statusEl.textContent = errStr;
            }
            return;
          }

          const { markdown } = data;
          outEl.textContent = markdown || '';
          resultSection.hidden = !markdown;
          statusEl.textContent = markdown ? '' : 'No content returned.';

          copyBtn.onclick = () => navigator.clipboard.writeText(markdown || '');
          dlBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([markdown || ''], { type: 'text/markdown' }));
            a.download = `${(component || 'component').toLowerCase()}-accessibility.md`;
            a.click();
          };
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'Generation failed. Check console for details.';
        } finally {
          clearLoading(); // spinner stops/hides when done or on error
        }
      });
    </script>
  </body>
</ht
