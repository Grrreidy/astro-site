---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---

<html lang="en">
  <head>
    <BaseHead title="RAG Componenta11y" description="Generate accessibility guidance powered by RAG data" />
  </head>
  <body>
    <Header />
    <main id="main-content" class="container blog">
      <h1 class="h1-small">RAG-powered accessibility guidance</h1>

      <form id="a11y-form" class="a11y-form" novalidate>
        <div class="form-field">
          <label for="component">Component</label>
          <input id="component" name="component" required aria-describedby="component-help" />
          <p id="component-help" class="field-help">
            Try: accordion, button, modal, tooltip...
          </p>
        </div>
        <button id="generate-btn" type="submit" class="default-button">
          <span>Generate guidance</span>
          <span id="btn-spinner" class="btn-spinner" aria-hidden="true"></span>
        </button>
        <p id="loading-msg">This references a lot of material, so it might take up to 30 seconds.</p>
      </form>

      <section id="result" class="a11y-result blog-content" hidden>
        <div id="output"></div>
      </section>
    </main>
    <Footer />

    <style>
      .btn-spinner {
        display: inline-block;
        width: 1em;
        height: 1em;
        margin-left: 0.5em;
        border: 0.2em solid currentColor;
        border-top: 0.2em solid transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        visibility: hidden;
      }
      .btn-spinner.active {
        visibility: visible;
      }
      @keyframes spin {
        100% { transform: rotate(360deg); }
      }
      #loading-msg {
        margin-top: 0.5em;
        font-size: var(--font-s);
        color: var(--text-secondary, #555);
        visibility: hidden;
      }
      #loading-msg.active {
        visibility: visible;
      }
    </style>

    <script type="module" is:inline>
      const form = document.getElementById('a11y-form');
      const spinner = document.getElementById('btn-spinner');
      const result = document.getElementById('result');
      const out = document.getElementById('output');
      const loadingMsg = document.getElementById('loading-msg');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const component = form.component.value.trim().toLowerCase();
        if (!component) return alert('Please enter a component name');

        spinner.classList.add('active');
        loadingMsg.classList.add('active');
        result.hidden = true;
        out.innerHTML = '';
        console.log('Submitting component:', component);

        try {
          const res = await fetch('/.netlify/functions/RAG-componenta11y', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ component })
          });
          console.log('Response status:', res.status);

          const text = await res.text();
          console.log('Raw response:', text);
          let data;
          try {
            data = JSON.parse(text);
          } catch {
            data = { error: text };
          }

          spinner.classList.remove('active');
          loadingMsg.classList.remove('active');

          if (data.html) {
            out.innerHTML = data.html;
            result.hidden = false;
          } else {
            out.textContent = data.error || 'No guidance returned.';
            result.hidden = false;
          }
        } catch (err) {
          spinner.classList.remove('active');
          loadingMsg.classList.remove('active');
          console.error('Fetch error:', err);
          out.textContent = 'Error: could not reach Netlify function.';
          result.hidden = false;
        }
      });
    </script>
  </body>
</html>
